# Arduino Motor Bridge — Firmware Spec (v1)

Этот документ — **техническое ТЗ** для новой прошивки Arduino под проект *Arduino Motor Bridge*.
Сервер (FastAPI) будет отправлять команды по Serial (USB), а прошивка должна:
- управлять моторами (A/B) и **до 5 сервоприводов**
- поддерживать режим питания серв (ARDUINO / EXTERNAL)
- выдавать телеметрию в JSON
- обеспечивать базовые **защиты/ failsafe** (watchdog, E-STOP, валидация)

---

## 1) Транспорт и формат

### Serial
- Скорость: задаётся на сервере (обычно 115200)
- Команда = **одна строка ASCII**, заканчивается `\n`
- Ответ = **одна строка**, заканчивается `\n`

### Ответы
- Успех: `OK <TOKEN> ...`
- Ошибка: `ERR <CODE> <MESSAGE>`

**Требование:** прошивка должна отвечать на любую команду либо `OK ...`, либо `ERR ...` (без молчания).

---

## 2) Команды (минимально необходимые)

### 2.1 Health-check
**Команда**
```
PING
```
**Ответ**
```
OK PONG
```

### 2.2 Возможности устройства
**Команда**
```
CAPS
```
**Ответ (пример)**
```
OK CAPS {"servo_count":5,"servo_deg_min":0,"servo_deg_max":180,"supports_batch":true,"supports_detach":true,"supports_estop":true}
```

---

## 3) Моторы (совместимость)

### 3.1 Установка тяги (PWM)
**Команды**
```
SetAEngine <speed>
SetBEngine <speed>
SetAllEngine <speed>
```
- `speed` диапазон: `-255..255`

**Ответы**
```
OK SETAENGINE
OK SETBENGINE
OK SETALLENGINE
```

**Ошибки**
- `ERR BAD_ARGS ...` — неверный диапазон
- `ERR ESTOP ...` — если включён E-STOP (см. ниже)

---

## 4) Сервоприводы (до 5)

### 4.1 Установка одного сервопривода
**Команда**
```
SetServo <id> <deg>
```
- `id`: `1..5`
- `deg`: `0..180` (или по внутренним лимитам, если включены)

**Ответ (пример)**
```
OK SETSERVO id=3 deg=120
```

### 4.2 Пакетная установка (желательно)
Нужна, чтобы одновременно выставлять несколько серв без “дребезга” и рассинхронизации.

**Команда**
```
SetServos {"items":[{"id":1,"deg":90},{"id":2,"deg":20},{"id":5,"deg":160}]}
```
**Ответ (пример)**
```
OK SETSERVOS {"applied":3}
```

### 4.3 Центрирование / safe pose
**Команда**
```
ServoCenter
```
**Ответ**
```
OK SERVO_CENTER
```

> Реализация: центровать все активные сервы (обычно 90°), либо выставлять заранее заданный “safe pose”.

### 4.4 Attach/Detach (опционально, но очень полезно)
Чтобы сервы не грелись/не дрожали без необходимости.

**Команды**
```
ServoAttach <id>
ServoDetach <id>
ServoDetachAll
```
**Ответы**
```
OK SERVO_ATTACH id=1
OK SERVO_DETACH id=1
OK SERVO_DETACH_ALL
```

---

## 5) Режим питания сервоприводов

**Команда**
```
ServoPwr ARDUINO
```
или
```
ServoPwr EXTERNAL
```

**Ответ**
```
OK SERVO_PWR mode=ARDUINO
```

### Поведение режимов
- **ARDUINO**: консервативные лимиты, ограничение скорости движения, запрет одновременного резкого движения многих серв (опционально)
- **EXTERNAL**: полный диапазон и более быстрые перемещения (в рамках безопасных лимитов)

---

## 6) Телеметрия (JSON)

**Команда**
```
TELEM
```

**Ответ**
```
OK TELEM { ...json... }
```

### Минимальная JSON-схема (рекомендуемая)
```json
{
  "uptime_ms": 123456,
  "motors": { "a": 0, "b": 0 },
  "servos": [
    {"id":1,"deg":90,"attached":true},
    {"id":2,"deg":90,"attached":true},
    {"id":3,"deg":90,"attached":false}
  ],
  "power": {
    "servo_mode": "ARDUINO",
    "vcc_mv": 4970
  },
  "faults": {
    "estop": false,
    "watchdog": false,
    "brownout": false,
    "cmd_reject": 0
  }
}
```

---

## 7) Безопасность / Защиты (обязательно)

### 7.1 Watchdog (deadman)
Если **нет валидных команд** дольше `T` секунд (например 1.5–3.0s), прошивка обязана:
- моторы → `0`
- сервы → `safe pose` *или* `detach` (что выберете)
- `faults.watchdog = true`

> Это ключевая защита, даже если сервер упал/отвалился USB.

### 7.2 E-STOP
**Команда**
```
EStop
```
**Ответ**
```
OK ESTOP state=ON
```

После включения E-STOP:
- Любые команды движения моторов/серв должны отвечать `ERR ESTOP ...`
- Разрешены только команды чтения (PING/CAPS/TELEM) и сброс E-STOP.

**Сброс**
```
EStop RESET
```
**Ответ**
```
OK ESTOP state=OFF
```

### 7.3 Валидация входных параметров
- Любой выход за диапазон → `ERR BAD_ARGS ...`
- Неизвестная команда → `ERR UNKNOWN_CMD ...`
- Неверный JSON → `ERR BAD_JSON ...`

### 7.4 (Опционально) Защита от “скачков” по серво
Можно внедрить ограничение скорости изменения:
- если за один тик пришёл скачок 0→180, прошивка делает плавный прогон (step-by-step),
- либо режет команду до безопасного шага и сообщает фактическое значение.

---

## 8) Совместимость с сервером

Сервер ожидает (минимум):
- ответы начинаются с `OK ...` или `ERR ...`
- `PING` → `OK PONG`
- `TELEM` → `OK TELEM {json}`
- `SetServo` → `OK SETSERVO ...`
- `ServoPwr` → `OK SERVO_PWR ...`

Если будет реализовано `SetServos`:
- сервер сможет отправлять batch-команды эффективнее (опционально).

---

## 9) Рекомендации по реализации

- Парсер команд: split по пробелам, первая часть — команда, дальше аргументы
- Для JSON-batch: искать `{` и парсить всё после команды как JSON
- На стороне серво: использовать Servo library (или аналоги) и поддерживать attach/detach
- Хранить состояние: текущие PWM моторов, текущие deg/attached серв, флаги faults, mode питания
- Периодический тик (например 50–100 Hz) для watchdog и плавных перемещений

---

## 10) Acceptance Criteria (чек-лист)

1. `PING` всегда отвечает `OK PONG`.
2. `CAPS` возвращает корректный JSON, включая `servo_count`.
3. `SetServo 1 90` работает и отвечает `OK SETSERVO ...`.
4. `TELEM` возвращает JSON с `motors`, `servos`, `faults`.
5. При отсутствии команд > T секунд моторы становятся 0 (watchdog).
6. После `EStop` любые команды движения дают `ERR ESTOP`, до `EStop RESET`.
7. Неверные команды/аргументы дают `ERR ...`, не приводят к зависанию.

